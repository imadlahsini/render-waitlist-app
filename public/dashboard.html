<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>Tableau d'attente des clients</title>
    <style>
        /* Keeping your existing UI and layout intact */
        body { font-family: Arial, sans-serif; }
        .container { max-width: 800px; margin: 50px auto; padding: 20px; background-color: #f9f9f9; }
        h2 { text-align: center; }
        input, select, button { display: block; width: 100%; margin-bottom: 10px; padding: 10px; }
        ul { list-style-type: none; padding: 0; }
        li { padding: 10px; background-color: #e1e1e1; margin-bottom: 10px; display: flex; justify-content: space-between; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; }
        .delete-btn { background-color: red; color: white; border: none; padding: 5px 10px; }
        .error-popup { color: red; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h2>Tableau d'attente des clients</h2>

    <input type="text" id="customerName" placeholder="Entrez le nom du client">
    
    <div>
        <label for="hourPicker">Heure:</label>
        <select id="hourPicker">
            <!-- Hours 07 to 19 -->
            <option value="07">07</option>
            <option value="08">08</option>
            <option value="09">09</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
            <option value="17">17</option>
            <option value="18">18</option>
            <option value="19">19</option>
        </select>

        <label for="minutePicker">Minutes:</label>
        <select id="minutePicker">
            <!-- Minutes 00, 15, 30, 45 -->
            <option value="00">00</option>
            <option value="15">15</option>
            <option value="30">30</option>
            <option value="45">45</option>
        </select>
    </div>

    <select id="visitType">
        <option value="Walkin">Walk-in</option>
        <option value="RDV">RDV</option>
    </select>

    <button onclick="addCustomer()">Ajouter un client</button>

    <div class="error-popup" id="errorPopup" style="display:none;">Erreur: Veuillez vérifier vos entrées.</div>

    <h3>Liste des clients</h3>
    <ul id="customerList"></ul>
</div>

<script>
    // Show error message
    function showError(message) {
        const errorPopup = document.getElementById('errorPopup');
        errorPopup.textContent = message;
        errorPopup.style.display = 'block';
        setTimeout(() => errorPopup.style.display = 'none', 3000);
    }

    // Fetch customers from the PostgreSQL database
    async function fetchCustomers() {
        try {
            const response = await fetch('/api/waitlist');
            return await response.json();
        } catch (err) {
            console.error('Error fetching customers:', err);
            showError('Erreur lors du chargement des clients.');
        }
    }

    // Display customers in the list
    async function displayCustomers() {
        const customers = await fetchCustomers();
        const customerList = document.getElementById('customerList');
        customerList.innerHTML = ''; // Clear the list

        customers.forEach((customer, index) => {
            const li = document.createElement('li');
            li.innerHTML = `
                ${index + 1}. ${customer.name} (${customer.time}) - ${customer.type}
                <button class="delete-btn" onclick="removeCustomer(${customer.id})">Supprimer</button>
            `;
            customerList.appendChild(li);
        });
    }

    // Add a customer to the PostgreSQL database
    async function addCustomer() {
        const customerName = document.getElementById('customerName').value.trim();
        const selectedHour = document.getElementById('hourPicker').value;
        const selectedMinute = document.getElementById('minutePicker').value;
        const customerTime = `${selectedHour}:${selectedMinute}`;
        const visitType = document.getElementById('visitType').value;

        if (!customerName || !customerTime) {
            showError('Veuillez entrer toutes les informations.');
            return;
        }

        const customer = { name: customerName, time: customerTime, type: visitType };

        try {
            await fetch('/api/waitlist', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(customer)
            });
            displayCustomers(); // Refresh the list after adding
            document.getElementById('customerName').value = ''; // Clear input
        } catch (err) {
            console.error('Error adding customer:', err);
            showError('Erreur lors de l\'ajout du client.');
        }
    }

    // Remove a customer from the PostgreSQL database
    async function removeCustomer(id) {
        try {
            await fetch(`/api/waitlist/${id}`, {
                method: 'DELETE'
            });
            displayCustomers(); // Refresh the list after deletion
        } catch (err) {
            console.error('Error removing customer:', err);
            showError('Erreur lors de la suppression du client.');
        }
    }

    // Initialize the customer list when the page loads
    window.onload = displayCustomers;
</script>

</body>
</html>
